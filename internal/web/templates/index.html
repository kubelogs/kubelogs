<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kubelogs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        mono: ['JetBrains Mono', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    },
                },
            },
        }
    </script>
    <script defer src="https://unpkg.com/alpinejs@3.14.3/dist/cdn.min.js"></script>
    <style>
        /* Custom scrollbar for dark mode */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex flex-col font-sans"
      x-data="app()"
      x-init="init()"
      @keydown.window="handleKeydown($event)">

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 px-4 py-3 flex-shrink-0">
        <div class="flex items-center gap-4 flex-wrap">
            <!-- Logo -->
            <h1 class="text-xl font-semibold text-white">kubelogs</h1>

            <!-- Namespace filter -->
            <div class="flex items-center gap-2">
                <label class="text-gray-400 text-sm">Namespace:</label>
                <select x-model="filters.namespace"
                        @change="applyFilters()"
                        class="bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All</option>
                    <template x-for="ns in namespaces" :key="ns">
                        <option :value="ns" x-text="ns"></option>
                    </template>
                </select>
            </div>

            <!-- Container filter -->
            <div class="flex items-center gap-2">
                <label class="text-gray-400 text-sm">Container:</label>
                <select x-model="filters.container"
                        @change="applyFilters()"
                        class="bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All</option>
                    <template x-for="c in containers" :key="c">
                        <option :value="c" x-text="c"></option>
                    </template>
                </select>
            </div>

            <!-- Severity filter -->
            <div class="flex items-center gap-2">
                <label class="text-gray-400 text-sm">Level:</label>
                <select x-model="filters.minSeverity"
                        @change="applyFilters()"
                        class="bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="0">All</option>
                    <option value="1">Trace+</option>
                    <option value="2">Debug+</option>
                    <option value="3">Info+</option>
                    <option value="4">Warn+</option>
                    <option value="5">Error+</option>
                    <option value="6">Fatal</option>
                </select>
            </div>

            <!-- Search input -->
            <div class="flex items-center gap-2">
                <label class="text-gray-400 text-sm">Search:</label>
                <input type="text"
                       x-model="filters.search"
                       x-ref="searchInput"
                       @keydown.enter="applyFilters()"
                       @input.debounce.500ms="applyFilters()"
                       placeholder="Search logs..."
                       class="bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-sm w-48 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- Time span filter -->
            <div class="flex items-center gap-2">
                <label class="text-gray-400 text-sm">Time:</label>
                <select x-model="filters.timeSpan"
                        @change="applyFilters()"
                        class="bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="live">Live</option>
                    <option value="0">All time</option>
                    <option value="15">Last 15 min</option>
                    <option value="30">Last 30 min</option>
                    <option value="60">Last 1 hour</option>
                    <option value="360">Last 6 hours</option>
                    <option value="1440">Last 24 hours</option>
                </select>
            </div>

            <!-- Tail toggle - only visible in Live mode -->
            <button x-show="filters.timeSpan === 'live'"
                    @click="toggleTail()"
                    :class="tailing ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-600 hover:bg-gray-500'"
                    class="px-3 py-1.5 rounded text-sm font-medium transition-colors">
                <span x-text="tailing ? 'Tailing' : 'Paused'"></span>
            </button>

            <!-- Clear button -->
            <button @click="clearLogs()"
                    class="px-3 py-1.5 rounded text-sm font-medium bg-gray-600 hover:bg-gray-500 transition-colors">
                Clear
            </button>

            <!-- Stats -->
            <div class="ml-auto flex items-center gap-4 text-sm text-gray-400">
                <span x-show="stats.totalEntries > 0">
                    <span x-text="stats.totalEntries.toLocaleString()"></span> entries
                </span>
                <span class="text-gray-500">
                    Press <kbd class="bg-gray-700 px-1.5 py-0.5 rounded text-xs font-mono">?</kbd> for shortcuts
                </span>
            </div>
        </div>
    </header>

    <!-- Log entries -->
    <main class="flex-1 overflow-auto font-mono text-sm transition-all duration-300"
          :class="detailPanelOpen ? 'mr-96' : ''"
          x-ref="logContainer" @scroll="handleScroll($event)">
        <!-- Loading older entries indicator -->
        <div x-show="loadingOlder"
             class="sticky top-0 z-10 bg-gray-800 text-center py-2 text-sm text-gray-400 border-b border-gray-700">
            <span class="animate-pulse">Loading older entries...</span>
        </div>

        <table class="w-full">
            <thead class="sticky top-0 bg-gray-800 text-gray-400 text-xs uppercase">
                <tr>
                    <th class="px-2 py-2 text-left w-44">Timestamp</th>
                    <th class="px-2 py-2 text-left w-32">Container</th>
                    <th class="px-2 py-2 text-left w-16">Level</th>
                    <th class="px-2 py-2 text-left">Message</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="entry in entries" :key="entry.id">
                    <tr class="hover:bg-gray-800/50 border-b border-gray-800/50 cursor-pointer"
                        :class="[severityRowClass(entry.severity), selectedEntry?.id === entry.id ? 'bg-blue-900/30' : '']"
                        :data-id="entry.id"
                        @click="selectEntry(entry)">
                        <td class="px-2 py-1 text-gray-500 whitespace-nowrap align-top"
                            x-text="formatTimestamp(entry.timestamp)"></td>
                        <td class="px-2 py-1 text-blue-400 whitespace-nowrap align-top truncate max-w-32"
                            :title="entry.container"
                            x-text="entry.container"></td>
                        <td class="px-2 py-1 whitespace-nowrap align-top font-semibold"
                            :class="severityClass(entry.severity)"
                            x-text="severityLabel(entry.severity)"></td>
                        <td class="px-2 py-1 break-all text-gray-200"><span class="whitespace-pre-wrap" x-text="entry.message"></span><template x-if="entry.attrs && Object.keys(entry.attrs).length > 0"><span class="inline-flex flex-wrap gap-1 ml-2 text-xs align-middle"><template x-for="(pair, idx) in Object.entries(entry.attrs)" :key="pair[0]"><span x-show="idx < 3" class="inline-flex bg-gray-700 rounded px-1.5 py-0.5"><span class="text-gray-500" x-text="pair[0] + '='"></span><span class="text-gray-300" x-text="truncateValue(pair[1])"></span></span></template><span x-show="Object.keys(entry.attrs).length > 3" class="text-gray-500 px-1">+<span x-text="Object.keys(entry.attrs).length - 3"></span></span></span></template></td>
                    </tr>
                </template>
            </tbody>
        </table>

        <!-- Empty state -->
        <div x-show="entries.length === 0" class="flex items-center justify-center h-full text-gray-500">
            <div class="text-center">
                <p class="text-lg mb-2">No logs yet</p>
                <p class="text-sm">Waiting for log entries...</p>
            </div>
        </div>
    </main>

    <!-- Detail Panel (slide-in from right) -->
    <aside x-show="detailPanelOpen"
           x-transition:enter="transition ease-out duration-300"
           x-transition:enter-start="translate-x-full"
           x-transition:enter-end="translate-x-0"
           x-transition:leave="transition ease-in duration-200"
           x-transition:leave-start="translate-x-0"
           x-transition:leave-end="translate-x-full"
           class="fixed right-0 top-0 h-full w-96 bg-gray-800 border-l border-gray-700 shadow-xl z-40 flex flex-col overflow-hidden"
           @click.outside="closeDetailPanel()">

        <!-- Panel Header -->
        <div class="flex items-center justify-between px-4 py-3 border-b border-gray-700 bg-gray-800">
            <h2 class="text-lg font-semibold">Log Details</h2>
            <button @click="closeDetailPanel()"
                    class="text-gray-400 hover:text-white p-1 rounded hover:bg-gray-700"
                    aria-label="Close panel">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Panel Content -->
        <div class="flex-1 overflow-auto p-4 space-y-4" x-show="selectedEntry">
            <!-- Timestamp -->
            <div>
                <dt class="text-xs text-gray-500 uppercase tracking-wide mb-1">Timestamp</dt>
                <dd class="text-gray-200 font-mono text-sm" x-text="formatTimestamp(selectedEntry?.timestamp)"></dd>
            </div>

            <!-- Kubernetes Context -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <dt class="text-xs text-gray-500 uppercase tracking-wide mb-1">Namespace</dt>
                    <dd class="text-blue-400 font-mono text-sm" x-text="selectedEntry?.namespace || '-'"></dd>
                </div>
                <div>
                    <dt class="text-xs text-gray-500 uppercase tracking-wide mb-1">Pod</dt>
                    <dd class="text-blue-400 font-mono text-sm truncate"
                        :title="selectedEntry?.pod"
                        x-text="selectedEntry?.pod || '-'"></dd>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <dt class="text-xs text-gray-500 uppercase tracking-wide mb-1">Container</dt>
                    <dd class="text-blue-400 font-mono text-sm" x-text="selectedEntry?.container || '-'"></dd>
                </div>
                <div>
                    <dt class="text-xs text-gray-500 uppercase tracking-wide mb-1">Level</dt>
                    <dd class="font-mono text-sm font-semibold"
                        :class="severityClass(selectedEntry?.severity)"
                        x-text="severityLabel(selectedEntry?.severity)"></dd>
                </div>
            </div>

            <!-- Message -->
            <div>
                <dt class="text-xs text-gray-500 uppercase tracking-wide mb-1">Message</dt>
                <dd class="text-gray-200 font-mono text-sm whitespace-pre-wrap break-all bg-gray-900 rounded p-3 max-h-48 overflow-auto"
                    x-text="selectedEntry?.message"></dd>
            </div>

            <!-- Attributes -->
            <div x-show="selectedEntry?.attrs && Object.keys(selectedEntry.attrs).length > 0">
                <dt class="text-xs text-gray-500 uppercase tracking-wide mb-2">
                    Attributes
                    <span class="text-gray-600" x-text="'(' + Object.keys(selectedEntry?.attrs || {}).length + ')'"></span>
                </dt>
                <dd class="space-y-1">
                    <template x-for="(val, key) in selectedEntry?.attrs || {}" :key="key">
                        <div class="flex bg-gray-900 rounded px-2 py-1.5 font-mono text-sm">
                            <span class="text-purple-400 mr-2 flex-shrink-0" x-text="key"></span>
                            <span class="text-gray-300 break-all" x-text="val"></span>
                        </div>
                    </template>
                </dd>
            </div>

            <!-- No Attributes State -->
            <div x-show="!selectedEntry?.attrs || Object.keys(selectedEntry.attrs).length === 0"
                 class="text-gray-500 text-sm italic">
                No attributes available
            </div>
        </div>

        <!-- Panel Footer with Navigation -->
        <div class="px-4 py-3 border-t border-gray-700 bg-gray-800 flex justify-between items-center text-sm text-gray-400">
            <span>Press <kbd class="bg-gray-700 px-1.5 py-0.5 rounded text-xs">Esc</kbd> to close</span>
            <span>
                <kbd class="bg-gray-700 px-1.5 py-0.5 rounded text-xs">j</kbd>
                <kbd class="bg-gray-700 px-1.5 py-0.5 rounded text-xs">k</kbd> navigate
            </span>
        </div>
    </aside>

    <!-- Connection status - only in Live mode -->
    <div x-show="!connected && filters.timeSpan === 'live'"
         class="fixed bottom-4 right-4 bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg">
        Reconnecting...
    </div>

    <!-- Jump to now button - only in Live mode -->
    <div x-show="!tailing && entries.length > 0 && filters.timeSpan === 'live'"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0 translate-y-4"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 translate-y-4"
         class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-10">
        <button @click="toggleTail()"
                class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-full shadow-lg text-sm font-medium transition-colors flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
            </svg>
            Jump to now
        </button>
    </div>

    <!-- Keyboard shortcuts modal -->
    <div x-show="showShortcuts"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/60 flex items-center justify-center z-50"
         @click.self="showShortcuts = false"
         @keydown.escape.window="showShortcuts = false">
        <div class="bg-gray-800 border border-gray-700 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
            <h2 class="text-lg font-semibold mb-4">Keyboard Shortcuts</h2>
            <dl class="grid grid-cols-2 gap-x-8 gap-y-2 text-sm">
                <dt><kbd class="bg-gray-700 px-2 py-0.5 rounded font-mono">/</kbd></dt>
                <dd class="text-gray-400">Focus search</dd>

                <dt><kbd class="bg-gray-700 px-2 py-0.5 rounded font-mono">?</kbd></dt>
                <dd class="text-gray-400">Show/hide shortcuts</dd>

                <dt><kbd class="bg-gray-700 px-2 py-0.5 rounded font-mono">t</kbd></dt>
                <dd class="text-gray-400">Toggle tailing</dd>

                <dt><kbd class="bg-gray-700 px-2 py-0.5 rounded font-mono">c</kbd></dt>
                <dd class="text-gray-400">Clear logs</dd>

                <dt><kbd class="bg-gray-700 px-2 py-0.5 rounded font-mono">g</kbd></dt>
                <dd class="text-gray-400">Go to top</dd>

                <dt><kbd class="bg-gray-700 px-2 py-0.5 rounded font-mono">G</kbd></dt>
                <dd class="text-gray-400">Go to bottom</dd>

                <dt><kbd class="bg-gray-700 px-2 py-0.5 rounded font-mono">u</kbd></dt>
                <dd class="text-gray-400">Load older entries</dd>

                <dt><kbd class="bg-gray-700 px-2 py-0.5 rounded font-mono">1-6</kbd></dt>
                <dd class="text-gray-400">Set severity filter</dd>

                <dt><kbd class="bg-gray-700 px-2 py-0.5 rounded font-mono">j</kbd> / <kbd class="bg-gray-700 px-2 py-0.5 rounded font-mono">k</kbd></dt>
                <dd class="text-gray-400">Navigate entries (in panel)</dd>

                <dt><kbd class="bg-gray-700 px-2 py-0.5 rounded font-mono">Esc</kbd></dt>
                <dd class="text-gray-400">Close panel / Clear filters</dd>
            </dl>
            <button @click="showShortcuts = false"
                    class="mt-6 w-full bg-gray-700 hover:bg-gray-600 py-2 rounded transition-colors">
                Close
            </button>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
</body>
</html>
